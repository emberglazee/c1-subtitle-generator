const STYLES=[{value:"pw",name:"Project Wingman (Roboto)",font:"Roboto"},{value:"ac7",name:"Ace Combat 7 (Aces07)",font:"Aces07"},{value:"acz",name:"Ace Combat Zero (Frutiger)",font:"Frutiger"},{value:"ac6",name:"Armored Core 6 (Folio)",font:"Folio-Std-Light"}],GRADIENTS={trans:["#55CDFC","#F7A8B8","#FFFFFF","#F7A8B8","#55CDFC"],rainbow:["#FF0000","#FFA500","#FFFF00","#00FF00","#0000FF","#4B0082","#9400D3"],italian:["#009246","#FFFFFF","#CE2B37"],french:["#0055A4","#FFFFFF","#EF4135"],irish:["#009A49","#FFFFFF","#FF7900"]},GRADIENT_OPTIONS=[{value:"none",name:"None"},{value:"trans",name:"ðŸ³ï¸â€âš§ï¸ Trans Flag"},{value:"rainbow",name:"ðŸ³ï¸â€ðŸŒˆ LGBTQ Flag"},{value:"italian",name:"ðŸ‡®ðŸ‡¹ Italian Flag"},{value:"french",name:"ðŸ‡«ðŸ‡· French Flag"},{value:"irish",name:"ðŸ‡®ðŸ‡ª Irish Flag"}],COLORS={basic:[{name:"Red",hex:"#FF5555"},{name:"Orange",hex:"#FFA500"},{name:"Yellow",hex:"#FFFF55"},{name:"Lime",hex:"#32CD32"},{name:"Green",hex:"#55FF55"},{name:"Cyan",hex:"#55FFFF"},{name:"Blue",hex:"#5555FF"},{name:"Navy",hex:"#000080"},{name:"Purple",hex:"#8A2BE2"},{name:"Pink",hex:"#FF55FF"},{name:"Brown",hex:"#A52A2A"},{name:"Teal",hex:"#008080"},{name:"Gray",hex:"#B0B0B0"},{name:"White",hex:"#FFFFFF"}],roles:[{name:"Priority Red",hex:"#FF0000"},{name:"Hostile Red",hex:"#e74c3c"},{name:"Peacekeeper Red",hex:"#992D22"},{name:"The Home Depot Orange",hex:"#F96302"},{name:"FakeDev Orange",hex:"#E67E22"},{name:"â­ Yellow",hex:"#fdb401"},{name:"Mad Yellow",hex:"#f1c40f"},{name:"Wikiyellow",hex:"#FFB40B"},{name:"Mercenary Yellow",hex:"#BBAD2C"},{name:"Faust/Goblin Green",hex:"#1F8b4C"},{name:"PWcord Moderator Turquoise",hex:"#1ABC9C"},{name:"Cascadian Teal",hex:"#2BBCC2"},{name:"Voice Actor Blue",hex:"#86A4C7"},{name:"Friendly Blue",hex:"#3498db"},{name:"Federation Dark Blue",hex:"#0C0D3B"},{name:"Ridel Purple",hex:"#71368A"},{name:"Gremlin Pink",hex:"#ff00dc"},{name:"Mugged Pink",hex:"#FFABF3"},{name:"Potato Brown",hex:"#c8a186"}],characters:[{name:"Ikuyo Red",hex:"#d8615d"},{name:"Nijika Yellow",hex:"#f8dc88"},{name:"Bocchi Pink",hex:"#f5b2c4"},{name:"Kikuri Pink",hex:"#8e577a"},{name:"Ryo Blue",hex:"#5378af"}]},CONFIG={fontSize:48,padding:40,minWidth:1024,maxWidth:2048,arrowQuoteWidth:80},els={style:document.getElementById("style"),speaker:document.getElementById("speaker"),quote:document.getElementById("quote"),colorPicker:document.getElementById("colorPicker"),colorText:document.getElementById("colorText"),colorPreset:document.getElementById("colorPreset"),gradient:document.getElementById("gradient"),stretch:document.getElementById("stretchGradient"),continuous:document.getElementById("continuousGradient"),dlBtn:document.getElementById("downloadBtn"),copyBtn:document.getElementById("copyBtn"),canvas:document.getElementById("canvas"),ac6Options:document.getElementById("ac6-options"),ac6ForceColor:document.getElementById("ac6ForceColor"),colorOptionsWrapper:document.getElementById("color-options-wrapper")};function measureWordWidth(e,t){return e.measureText(t).width}function wrapText(e,t,n){const o=[];return t.split("\n").forEach(t=>{t.split(" ").forEach((t,l)=>{measureWordWidth(e,t);const a=o.length-1,r=0===l;if(0===o.length||r)o.push(t);else{const l=`${o[a]} ${t}`;measureWordWidth(e,l)<=n?o[a]=l:o.push(t)}})}),o}async function generateSubtitle(){const e=els.style.value,t=els.speaker.value,n=els.quote.value,o=document.querySelector('input[name="colorType"]:checked').value;let l,a;const r="gradient"===o;switch(o){case"preset":l=els.colorPreset.value;break;case"gradient":if("preset"===document.querySelector('input[name="gradientType"]:checked').value){const e=els.gradient.value;"none"!==e&&(a=GRADIENTS[e])}else{const e=document.querySelectorAll('#custom-gradient-colors .custom-gradient-color-item input[type="text"]');a=Array.from(e).map(e=>e.value).filter(Boolean),0===a.length&&(a=["#FFFFFF"])}break;default:l=els.colorText.value}const c=els.stretch.checked,i=els.continuous.checked,s=els.ac6ForceColor.checked;let d;"ac6"!==e||s||(r&&(a=["#FFFFFF"]),l="#FFFFFF"),d=r&&a&&a.length>0?a[0]:l||els.colorText.value;const u=STYLES.find(t=>t.value===e).font;await document.fonts.ready;const h=els.canvas.getContext("2d"),m=CONFIG.fontSize,p=`${m}px ${u}`;await document.fonts.load(p),h.font=p;const g="ac7"===e||"acz"===e,F="acz"===e||"ac6"===e,y=g?CONFIG.arrowQuoteWidth:0,x=h.measureText(t).width,f=h.measureText(n).width;let v=Math.max(CONFIG.minWidth,Math.min(Math.max(x,f)+2*CONFIG.padding+y,CONFIG.maxWidth));const C=v-2*CONFIG.padding-y,E=wrapText(h,t,C),T=wrapText(h,n,C),S=1.2*m,B=F?S/4+S/2+2:0;let w=50+E.length*S+2+T.length*S+CONFIG.padding+(B>0?B-2:0);els.canvas.width=v,els.canvas.height=w,h.clearRect(0,0,v,w),h.font=p,h.textAlign="center",h.textBaseline="top",h.shadowColor="black",h.shadowBlur=8;const b=v/2;let k=50;if(r&&a&&0!==a.length){let e=0;E.forEach(t=>{const n=h.measureText(t).width;if(0===n)return void(k+=S);const o=b-n/2;if(i)if(c){const e=h.createLinearGradient(o,0,o+n,0);a.forEach((t,n)=>{const o=a.length>1?n/(a.length-1):.5;e.addColorStop(o,t)}),h.fillStyle=e,h.textAlign="center",h.fillText(t,b,k)}else{const e=150,n=document.createElement("canvas");n.width=e,n.height=1;const l=n.getContext("2d"),r=l.createLinearGradient(0,0,e,0),c=a.length>1?[...a,a[0]]:a;c.forEach((e,t)=>{const n=c.length>1?t/(c.length-1):.5;r.addColorStop(n,e)}),l.fillStyle=r,l.fillRect(0,0,e,1);const i=h.createPattern(n,"repeat-x");h.fillStyle=i,h.save(),h.translate(o,0),h.textAlign="left",h.fillText(t,0,k),h.restore()}else{let l=o;if(h.textAlign="left",c)for(let e=0;e<t.length;e++){const r=t[e],c=h.measureText(r).width,i=(l+c/2-o)/n;let s=Math.floor(i*a.length);s=Math.min(s,a.length-1),h.fillStyle=a[s],h.fillText(r,l,k),l+=c}else for(let n=0;n<t.length;n++){const o=t[n],r=(e+n)%a.length;h.fillStyle=a[r],h.fillText(o,l,k),l+=h.measureText(o).width}h.textAlign="center"}e+=t.length,k+=S})}else h.fillStyle=d,E.forEach(e=>{h.fillText(e,b,k),k+=S});if(F){const t=Math.max(...E.map(e=>h.measureText(e).width));let n,o;k+=S/4;let l=d;if("ac6"===e){n=800,o=b-n/2;const e=h.createLinearGradient(o,0,o+n,0),t=`rgba(${parseInt(d.slice(1,3),16)}, ${parseInt(d.slice(3,5),16)}, ${parseInt(d.slice(5,7),16)}, 0)`;e.addColorStop(0,t),e.addColorStop(.25,d),e.addColorStop(.75,d),e.addColorStop(1,t),l=e}else n=1.2*t,o=b-n/2;h.fillStyle=l,h.fillRect(o,k,n,2),k+=2,k+=S/2}k+=2;if(r&&a&&a.length>0&&"acz"===e){let e=0;T.forEach((t,n)=>{const o=0===n,l=n===T.length-1;if(i){const e=h.measureText(t).width;let n=[{text:t,width:e,x:b}];if(g){if(o){const t=h.measureText("<<").width;n.unshift({text:"<<",width:t,x:b-e/2-40})}if(l){const t=h.measureText(">>").width;n.push({text:">>",width:t,x:b+e/2+40})}}const r=n[0].x-n[0].width/2,i=n[n.length-1].x+n[n.length-1].width/2;let s;if(c)s=h.createLinearGradient(r,0,i,0),a.forEach((e,t)=>{const n=a.length>1?t/(a.length-1):.5;s.addColorStop(n,e)});else{const e=150,t=document.createElement("canvas");t.width=e,t.height=1;const n=t.getContext("2d"),o=n.createLinearGradient(0,0,e,0),l=a.length>1?[...a,a[0]]:a;l.forEach((e,t)=>{const n=l.length>1?t/(l.length-1):.5;o.addColorStop(n,e)}),n.fillStyle=o,n.fillRect(0,0,e,1),s=h.createPattern(t,"repeat-x")}h.fillStyle=s,h.save(),c?n.forEach(e=>{h.fillText(e.text,e.x,k)}):(h.translate(r,0),h.textAlign="left",n.forEach(e=>{const t=e.x-e.width/2-r;h.fillText(e.text,t,k)})),h.restore()}else{const n=[...t.split("")];g&&o&&n.unshift("<<"),g&&l&&n.push(">>");const r=h.measureText(t).width,i=(h.measureText("<<").width,[]);g&&o&&i.push({text:"<<",x:b-r/2-40}),t.split("").forEach((e,n)=>{const o=t.substring(0,n),l=h.measureText(o).width,a=h.measureText(e).width;i.push({text:e,x:b-r/2+l+a/2})}),g&&l&&i.push({text:">>",x:b+r/2+40});let s=0,d=0;if(i.length>0){const e=i[0],t=i[i.length-1];d=e.x-h.measureText(e.text).width/2;const n=t.x+h.measureText(t.text).width/2;s=n-d}h.textAlign="center",c?i.forEach(e=>{const t=h.measureText(e.text).width,n=(e.x-t/2+t/2-d)/s;let o=Math.floor(n*a.length);o=Math.min(o,a.length-1),h.fillStyle=a[o],h.fillText(e.text,e.x,k)}):(i.forEach((t,n)=>{const o=(e+n)%a.length;h.fillStyle=a[o],h.fillText(t.text,t.x,k)}),e+=i.length)}k+=S})}else h.fillStyle="acz"===e?d:"white",T.forEach((e,t)=>{if(g){const n=h.measureText(e).width,o=b-n/2-40,l=b+n/2+40;0===t&&(h.save(),h.fillStyle=r&&a?a[0]:d,h.fillText("<<",o,k),h.restore()),t===T.length-1&&(h.save(),h.fillStyle=r&&a?a[a.length-1]:d,h.fillText(">>",l,k),h.restore())}h.fillText(e,b,k),k+=S})}function setupColorControls(){const e=document.querySelectorAll('input[name="colorType"]'),t=document.getElementById("customColor-group"),n=document.getElementById("preset-group"),o=document.getElementById("gradient-options-container"),l=document.querySelector(".checkbox-group"),a=document.querySelectorAll('input[name="gradientType"]'),r=document.getElementById("gradient-group"),c=document.getElementById("custom-gradient-group");function i(){const e=document.querySelector('input[name="gradientType"]:checked').value;r.style.display="preset"===e?"block":"none",c.style.display="custom"===e?"block":"none"}function s(){const e=document.querySelector('input[name="colorType"]:checked').value;t.style.display="none",n.style.display="none",o.style.display="none",l.style.display="none","custom"===e?t.style.display="block":"preset"===e?n.style.display="block":"gradient"===e&&(o.style.display="block",l.style.display="flex",i())}e.forEach(e=>{e.addEventListener("change",()=>{s(),handleAutoGenerate()})}),a.forEach(e=>{e.addEventListener("change",()=>{i(),handleAutoGenerate()})}),s()}function updateUIVisibility(){const e=els.style.value,t=els.ac6ForceColor.checked;els.ac6Options.style.display="ac6"===e?"block":"none";const n="ac6"!==e||t;els.colorOptionsWrapper.style.display=n?"block":"none"}function populateSelect(e,t,n=!1){n&&(e.innerHTML=""),t.forEach(t=>{const n=document.createElement("option");n.value=t.value,n.textContent=t.name,e.appendChild(n)})}function populateAllOptions(){populateSelect(els.style,STYLES,!0),populateSelect(els.gradient,GRADIENT_OPTIONS,!0);const e=els.colorPreset,t=(e,t)=>{const n=document.createElement("optgroup");return n.label=e,t.forEach(e=>{const t=document.createElement("option");t.value=e.hex,t.textContent=e.name,n.appendChild(t)}),n};e.appendChild(t("Basic",COLORS.basic)),e.appendChild(t("Roles",COLORS.roles)),e.appendChild(t("Characters",COLORS.characters))}function handleAutoGenerate(){generateSubtitle(),saveOptions()}function saveOptions(){const e=Array.from(document.querySelectorAll('#custom-gradient-colors .custom-gradient-color-item input[type="text"]')).map(e=>e.value),t={style:els.style.value,speaker:els.speaker.value,quote:els.quote.value,colorType:document.querySelector('input[name="colorType"]:checked').value,color:els.colorText.value,colorPreset:els.colorPreset.value,gradientType:document.querySelector('input[name="gradientType"]:checked').value,gradient:els.gradient.value,customGradientColors:e,stretch:els.stretch.checked,continuous:els.continuous.checked,ac6ForceColor:els.ac6ForceColor.checked};localStorage.setItem("subtitleGeneratorOptions",JSON.stringify(t))}function loadOptions(){const e=localStorage.getItem("subtitleGeneratorOptions");if(!e)return;const t=JSON.parse(e);if(els.style.value=t.style??"pw",els.speaker.value=t.speaker??"Crimson 1",els.quote.value=t.quote??"You're a slave to history.",els.colorText.value=t.color??"#FF0000",els.colorPicker.value=t.color??"#FF0000",els.colorPreset.value=t.colorPreset??"#FF5555",els.gradient.value=t.gradient??"none",els.stretch.checked=t.stretch??!1,els.continuous.checked=t.continuous??!1,els.ac6ForceColor.checked=t.ac6ForceColor??!1,t.colorType){const e=document.querySelector(`input[name="colorType"][value="${t.colorType}"]`);e&&(e.checked=!0)}if(t.gradientType){const e=document.querySelector(`input[name="gradientType"][value="${t.gradientType}"]`);e&&(e.checked=!0)}if(t.customGradientColors&&t.customGradientColors.length>0){document.getElementById("custom-gradient-colors").innerHTML="",t.customGradientColors.forEach(e=>addColorPicker(e))}}function getColorFromVirtualGradient(e,t){if(!e||0===e.length)return"#FFFFFF";if(1===e.length)return e[0];const n=Math.max(0,Math.min(1,t))*(e.length-1),o=Math.floor(n),l=Math.min(o+1,e.length-1),a=n-o,r=e[o],c=e[l];if(!r||!c)return"#FFFFFF";const i=parseInt(r.substring(1,3),16),s=parseInt(r.substring(3,5),16),d=parseInt(r.substring(5,7),16),u=parseInt(c.substring(1,3),16),h=parseInt(c.substring(3,5),16),m=parseInt(c.substring(5,7),16),p=Math.floor(i+(u-i)*a),g=Math.floor(s+(h-s)*a),F=Math.floor(d+(m-d)*a);return`#${p.toString(16).padStart(2,"0")}${g.toString(16).padStart(2,"0")}${F.toString(16).padStart(2,"0")}`}function setupAutoGenerate(){Object.values(els).forEach(e=>{if(e&&e.id&&!["downloadBtn","copyBtn","canvas"].includes(e.id)){const t="text"===e.type||"textarea"===e.type?"input":"change";e.addEventListener(t,handleAutoGenerate)}}),document.querySelectorAll('input[name="colorType"]').forEach(e=>{e.addEventListener("change",handleAutoGenerate)}),document.querySelectorAll('input[name="gradientType"]').forEach(e=>{e.addEventListener("change",handleAutoGenerate)})}function addColorPicker(e="#FFFFFF"){const t=document.getElementById("custom-gradient-colors"),n=document.createElement("div");n.className="custom-gradient-color-item";const o=document.createElement("input");o.type="color",o.value=e;const l=document.createElement("input");l.type="text",l.value=e,l.maxLength=7,o.addEventListener("input",()=>{l.value=o.value,handleAutoGenerate()}),l.addEventListener("input",()=>{/^#[0-9a-f]{6}$/i.test(l.value)&&(o.value=l.value,handleAutoGenerate())});const a=document.createElement("button");a.textContent="Ã—",a.className="remove-color-btn",a.type="button",a.title="Remove color",a.addEventListener("click",()=>{n.remove(),handleAutoGenerate()}),n.appendChild(o),n.appendChild(l),n.appendChild(a),t.appendChild(n)}function setupCustomGradientControls(){document.getElementById("addCustomGradientColorBtn").addEventListener("click",()=>{addColorPicker(),handleAutoGenerate()}),0===document.querySelectorAll("#custom-gradient-colors .custom-gradient-color-item").length&&(addColorPicker("#FF0000"),addColorPicker("#0000FF"))}els.colorPicker.addEventListener("input",e=>{els.colorText.value=e.target.value}),els.colorText.addEventListener("input",e=>{els.colorPicker.value=e.target.value}),els.style.addEventListener("change",updateUIVisibility),els.ac6ForceColor.addEventListener("change",updateUIVisibility),els.dlBtn.addEventListener("click",()=>{const e=document.createElement("a");e.download=`subtitle-${Date.now()}.png`,e.href=els.canvas.toDataURL(),e.click()}),els.copyBtn.addEventListener("click",()=>{els.canvas.toBlob(e=>{e?navigator.clipboard&&navigator.clipboard.write&&window.ClipboardItem?navigator.clipboard.write([new ClipboardItem({"image/png":e})]).then(()=>{const e=els.copyBtn.textContent;els.copyBtn.textContent="Copied!",els.copyBtn.disabled=!0,setTimeout(()=>{els.copyBtn.textContent=e,els.copyBtn.disabled=!1},2e3)}).catch(e=>{console.error("Could not copy image to clipboard: ",e),alert("Failed to copy image. Your browser might not support it or permissions were denied.")}):alert("Copying images to clipboard is not supported by your browser."):alert("Failed to create image blob for copying.")},"image/png")}),window.onload=()=>{populateAllOptions(),loadOptions(),setupColorControls(),setupCustomGradientControls(),updateUIVisibility(),setupAutoGenerate(),generateSubtitle(),console.log("Subtitle Generator Loaded")};